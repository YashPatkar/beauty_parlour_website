{% extends 'base.html' %}
{% load static %}
{% block title %}Pay with Razorpay - Beauty Parlour{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/razorpay-payment.css' %}">
{% endblock %}
{% block content %}
<section class="py-5 rzp-theme" style="background: #F7F8FA;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-6">
        <p class="text-muted small text-center mb-2">{{ appointment.service.name }} · {{ appointment.date }} at {{ appointment.time }}</p>
        <div class="rzp-container">
          <div class="rzp-header">
            <img src="https://cdn.razorpay.com/static/assets/logo/logo.svg" alt="Razorpay" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
            <span style="display:none; font-weight: 700; font-size: 1.25rem;">Razorpay</span>
            <div class="rzp-amount">Pay ₹{{ amount }}</div>
            <p class="small mb-0 opacity-90">Secure payment · No real charges</p>
          </div>
          <div class="rzp-body">
            <div class="rzp-tabs">
              <button type="button" class="rzp-tab active" data-tab="card">Cards</button>
              <button type="button" class="rzp-tab" data-tab="upi">UPI</button>
              <button type="button" class="rzp-tab" data-tab="netbanking">Net Banking</button>
            </div>

            <form method="post" action="" id="paymentForm">
              {% csrf_token %}
              <input type="hidden" name="pay_mode" value="razorpay">

              <!-- Card panel -->
              <div class="rzp-panel active" id="panel-card">
                {% if saved_methods %}
                <p class="small fw-bold text-secondary mb-2">Saved cards</p>
                {% for m in saved_methods %}
                <label class="rzp-saved-card">
                  <span>
                    <input type="radio" name="saved_card" value="{{ m.pk }}">
                    <span class="badge bg-{% if m.card_type == 'visa' %}primary{% elif m.card_type == 'mastercard' %}danger{% else %}secondary{% endif %} me-2">{{ m.get_card_type_display }}</span>
                    **** {{ m.last_four }}
                    {% if m.nickname %}<span class="text-muted">({{ m.nickname }})</span>{% endif %}
                  </span>
                </label>
                {% endfor %}
                <p class="rzp-new-card-link mb-2">+ Pay with new card</p>
                {% endif %}
                <div class="rzp-form {% if saved_methods %}d-none{% endif %}" id="newCardFields">
                  <div class="mb-3">
                    <label class="form-label">Card number</label>
                    <input type="text" class="form-control" placeholder="4111 1111 1111 1111" maxlength="19" pattern="[0-9\s]*" readonly onfocus="this.removeAttribute('readonly')">
                  </div>
                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label">Expiry</label>
                      <input type="text" class="form-control" placeholder="MM/YY" maxlength="5" readonly onfocus="this.removeAttribute('readonly')">
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label">CVV</label>
                      <input type="text" class="form-control" placeholder="123" maxlength="4" readonly onfocus="this.removeAttribute('readonly')">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Name on card</label>
                    <input type="text" class="form-control" placeholder="Name" value="{{ user.get_full_name|default:user.username }}">
                  </div>
                </div>
                <p class="text-muted small">No real card data is sent. Choose result below.</p>
                <div class="mb-3">
                  <label class="me-3"><input type="radio" name="simulate_success" value="1" checked> Success</label>
                  <label><input type="radio" name="simulate_success" value="0"> Failure</label>
                </div>
                <button type="submit" class="btn rzp-btn-pay">Pay ₹{{ amount }}</button>
              </div>

              <!-- UPI panel -->
              <div class="rzp-panel" id="panel-upi">
                <div class="mb-3">
                  <label class="form-label">UPI ID</label>
                  <input type="text" class="form-control" placeholder="yourname@upi" readonly onfocus="this.removeAttribute('readonly')">
                </div>
                <p class="text-muted small">Choose result below.</p>
                <div class="mb-3">
                  <label class="me-3"><input type="radio" name="simulate_success" value="1" checked> Success</label>
                  <label><input type="radio" name="simulate_success" value="0"> Failure</label>
                </div>
                <button type="submit" class="btn rzp-btn-pay">Pay ₹{{ amount }}</button>
              </div>

              <!-- Net Banking panel -->
              <div class="rzp-panel" id="panel-netbanking">
                <div class="mb-3">
                  <label class="form-label">Select bank</label>
                  <select class="form-select">
                    <option>State Bank of India</option>
                    <option>HDFC Bank</option>
                    <option>ICICI Bank</option>
                    <option>Axis Bank</option>
                    <option>Kotak Mahindra Bank</option>
                  </select>
                </div>
                <p class="text-muted small">Choose result below.</p>
                <div class="mb-3">
                  <label class="me-3"><input type="radio" name="simulate_success" value="1" checked> Success</label>
                  <label><input type="radio" name="simulate_success" value="0"> Failure</label>
                </div>
                <button type="submit" class="btn rzp-btn-pay">Pay ₹{{ amount }}</button>
              </div>
            </form>

            <div class="rzp-pay-at-salon">
              <form method="post" action="" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="pay_mode" value="salon">
                <button type="submit">Pay at salon (Cash/Card) instead</button>
              </form>
            </div>

            <p class="rzp-footer-note">This is a simulated payment. Razorpay logo and UI for reference. No real transaction.</p>
          </div>
        </div>
        <p class="text-center mt-3"><a href="{% url 'my_appointments' %}">Back to My Appointments</a></p>
      </div>
    </div>
  </div>
</section>
<script>
  document.querySelectorAll('.rzp-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      var t = this.getAttribute('data-tab');
      document.querySelectorAll('.rzp-tab').forEach(function(x) { x.classList.remove('active'); });
      document.querySelectorAll('.rzp-panel').forEach(function(x) { x.classList.remove('active'); });
      this.classList.add('active');
      var panel = document.getElementById('panel-' + t);
      if (panel) panel.classList.add('active');
    });
  });
  var newCardLink = document.querySelector('.rzp-new-card-link');
  var newCardFields = document.getElementById('newCardFields');
  if (newCardLink && newCardFields) {
    newCardLink.addEventListener('click', function() {
      document.querySelectorAll('input[name="saved_card"]').forEach(function(r) { r.checked = false; });
      newCardFields.classList.remove('d-none');
    });
  }
  document.querySelectorAll('input[name="saved_card"]').forEach(function(r) {
    r.addEventListener('change', function() {
      if (newCardFields) newCardFields.classList.add('d-none');
    });
  });
</script>
{% endblock %}
